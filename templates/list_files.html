<!-- templates/list_files.html -->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri: {{ folder_name }}</title>
    <link rel="stylesheet" href="/static/style.css?v=20240726">
    <style>
        /* Tambahan style manual agar tampilan rapi */
        .thumb-img.active { border-color: #007bff !important; opacity: 1; }
        .modal { display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { max-width: 90%; max-height: 85%; border: 3px solid white; border-radius: 5px; }
        #caption { color: white; margin-top: 15px; font-weight: bold; }
        .close { position: absolute; top: 20px; right: 35px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <nav>
        <a href="/">üè† Menu Utama</a> | 
        <a href="javascript:history.back()">‚¨ÖÔ∏è Kembali</a>
    </nav>
    
    <h1>Galeri: {{ folder_name }}</h1>

    {% if subfolders %}
    <h2>Subfolder:</h2>
    <ul>
        {% for subfolder in subfolders %}
            <li><a href="/gallery/{{ folder_name }}/{{ subfolder }}">{{ subfolder }}</a></li>
        {% endfor %}
    </ul>
    <hr>
    {% endif %}

    <h2>Gambar:</h2>

    <div class="gallery-wrapper" style="max-width: 800px; margin: 0 auto; padding: 20px;">
        <!-- 1. Tampilan Gambar Utama (Klik untuk Popup) -->
        <div class="main-display" style="width: 100%; margin-bottom: 20px; text-align: center;">
            {% if files %}
                <button onclick="navigateMain(-1)" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 15px; cursor: pointer; border-radius: 50%; z-index: 10;">‚ùÆ</button>
                
                <img id="active-image" src="{{ files[0] }}" alt="Main View" 
                     onclick="openLightbox()" 
                     style="width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px; border: 1px solid #444; cursor: zoom-in;">
                <button onclick="navigateMain(1)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 15px; cursor: pointer; border-radius: 50%; z-index: 10;">‚ùØ</button>
            {% endif %}
        </div>

        <!-- 2. Barisan Thumbnail -->
        <div class="thumbnail-container" style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scroll-behavior: smooth;">
            {% for file_url in files %}
            <div class="thumb-item" style="flex: 0 0 100px; display: flex; flex-direction: column; align-items: center;">
                <img class="thumb-img {% if loop.first %}active{% endif %}" 
                     src="{{ file_url }}" 
                     onclick="updatePreview(this, {{ loop.index0 }})"
                     style="width: 100px; height: 100px; object-fit: cover; cursor: pointer; border-radius: 4px; border: 2px solid transparent; transition: 0.2s;">
                
                <button onclick="deleteImage('{{ file_url }}')" 
                        style="margin-top: 5px; width: 100%; background: #ff4444; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">
                    Hapus
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-controls" style="margin-top: 20px; text-align: center;">
        {% if has_prev %}<a href="{{ prev_url }}" style="padding: 10px; background: #007bff; color: white; text-decoration: none; border-radius: 5px;">&laquo; Prev</a>{% endif %}
        <span style="margin: 0 15px;">Page {{ page }}</span>
        {% if has_next %}<a href="{{ next_url }}" style="padding: 10px; background: #007bff; color: white; text-decoration: none; border-radius: 5px;">Next &raquo;</a>{% endif %}
    </div>

    <!-- Lightbox Modal -->
    <div id="imageModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        
        <!-- Tombol Navigasi Kiri & Kanan -->
        <!-- <a class="prev-btn" onclick="navigateModal(-1)" style="position: absolute; left: 20px; color: white; font-size: 50px; cursor: pointer; user-select: none; z-index: 2100;">‚ùÆ</a> -->
        <!-- <a class="next-btn" onclick="navigateModal(1)" style="position: absolute; right: 20px; color: white; font-size: 50px; cursor: pointer; user-select: none; z-index: 2100;">‚ùØ</a> -->
        
        <!-- Gunakan class dari CSS kamu: .prev dan .next -->
        <a class="prev" onclick="navigateModal(-1)">‚ùÆ</a>
        <a class="next" onclick="navigateModal(1)">‚ùØ</a>
        <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
            <img class="modal-content" id="img01">
            <div id="caption"></div>
        </div>
    </div>

<script>
    // Inisialisasi daftar gambar dari template Jinja2
    const imageUrls = [{% for file_url in files %}"{{ file_url }}"{% if not loop.last %}, {% endif %}{% endfor %}];
    let currentIndex = 0;

    // 1. Fungsi Ganti Preview Gambar Utama
    function updatePreview(element, index) {
        currentIndex = index;
        const mainImg = document.getElementById('active-image');
        mainImg.src = element.src;

        // Update styling thumbnail aktif
        document.querySelectorAll('.thumb-img').forEach(img => img.classList.remove('active'));
        element.classList.add('active');
    }

    // 2. Fungsi Buka Modal (Popup)
    function openLightbox() {
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("img01");
        const captionText = document.getElementById("caption");

        modal.style.display = "flex";
        modalImg.src = imageUrls[currentIndex];
        
        // Ambil nama file untuk caption
        let filename = imageUrls[currentIndex].substring(imageUrls[currentIndex].lastIndexOf('/') + 1);
        captionText.innerHTML = decodeURIComponent(filename);
    }

    function closeModal() {
        document.getElementById("imageModal").style.display = "none";
    }

    // 3. Fungsi Hapus
    function deleteImage(relativeFilePath) {
        if (confirm("Apakah Anda yakin ingin menghapus gambar ini?")) {
            let cleanPath = relativeFilePath.replace('/view/', '');
            fetch(`/files/${encodeURIComponent(cleanPath)}`, { method: 'DELETE' })
                .then(response => response.ok ? location.reload() : alert("Gagal menghapus."));
        }
    }

    // Tutup modal jika klik luar gambar
    window.onclick = function(event) {
        const modal = document.getElementById("imageModal");
        if (event.target == modal) closeModal();
    }

    function navigateModal(step) {
        currentIndex += step;

        // Putar balik jika sudah di ujung list
        if (currentIndex >= imageUrls.length) {
            currentIndex = 0;
        } else if (currentIndex < 0) {
            currentIndex = imageUrls.length - 1;
        }

        const modalImg = document.getElementById("img01");
        const captionText = document.getElementById("caption");
        
        const newUrl = imageUrls[currentIndex];
        modalImg.src = newUrl;
        
        // Update caption
        let filename = newUrl.substring(newUrl.lastIndexOf('/') + 1);
        captionText.innerHTML = decodeURIComponent(filename);

        // Sinkronkan thumbnail aktif di latar belakang (opsional)
        const thumbs = document.querySelectorAll('.thumb-img');
        const mainImg = document.getElementById('active-image');
        mainImg.src = newUrl;
        thumbs.forEach(img => img.classList.remove('active'));
        thumbs[currentIndex].classList.add('active');
    }

    // Tambahkan kontrol keyboard
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById("imageModal");
        if (modal.style.display === "flex") {
            if (e.key === "ArrowLeft") navigateModal(-1);
            if (e.key === "ArrowRight") navigateModal(1);
            if (e.key === "Escape") closeModal();
        }
    });

    // Tambahkan atau gabungkan dengan event listener keydown yang sudah ada
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById("imageModal");
        
        // CEK: Jika modal sedang TIDAK terbuka (display none atau kosong)
        if (modal.style.display !== "flex") {
            if (e.key === "ArrowLeft") {
                navigateMain(-1);
            } else if (e.key === "ArrowRight") {
                navigateMain(1);
            }
        }
        
        // Logika modal yang sudah ada tetap dipertahankan
        if (modal.style.display === "flex") {
            if (e.key === "ArrowLeft") navigateModal(-1);
            if (e.key === "ArrowRight") navigateModal(1);
            if (e.key === "Escape") closeModal();
        }
    });
    // Fungsi Navigasi Utama (Untuk sinkronisasi tombol panah & thumbnail)
    function navigateMain(step) {
        currentIndex += step;

        // Loop index jika sudah sampai ujung
        if (currentIndex >= imageUrls.length) {
            currentIndex = 0;
        } else if (currentIndex < 0) {
            currentIndex = imageUrls.length - 1;
        }

        const thumbs = document.querySelectorAll('.thumb-img');
        const targetThumb = thumbs[currentIndex];
        
        // Jalankan fungsi updatePreview yang sudah Anda miliki
        updatePreview(targetThumb, currentIndex);

        // Tambahan: Pastikan thumbnail yang terpilih otomatis scroll ke tengah layar
        targetThumb.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
        });
    }

</script>
</body>
</html>
